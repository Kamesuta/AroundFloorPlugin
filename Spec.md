# AroundFloor Plugin 仕様書

## 概要
プレイヤーの周囲半径10m以内のエリアだけブロックを可視化するMinecraftプラグインです。y=-50～HEIGHTの範囲に設置されたブロックを、プレイヤーが近づいた時にy=50～HEIGHTの範囲にコピー表示し、プレイヤーが離れると消去します。

## 基本情報
- **プラグイン名**: AroundFloorPlugin
- **バージョン**: 1.0-SNAPSHOT
- **対応Minecraft**: 1.21
- **API**: Paper API
- **Java版**: 21

## 主要機能

### 1. ブロック可視化システム
- **動作範囲**: プレイヤーを中心とした半径10m（10ブロック）の円形エリア
- **対象レイヤー**: y=-50～HEIGHTの範囲に設置されたブロック
- **表示レイヤー**: y=50～HEIGHTの範囲にブロックをコピー表示
- **更新頻度**: リアルタイム（プレイヤーの移動に連動）

### 2. ブロックコピー機能
- **コピー元**: y=-50～HEIGHTの範囲のブロック
- **コピー先**: y=50～HEIGHTの範囲（相対的な高さを維持）
- **コピー条件**: プレイヤーが半径10m以内に存在する場合
- **削除条件**: プレイヤーが半径10m外に移動した場合
- **高さ変換**: sourceY → displayY = sourceY + 100（例：y=-50 → y=50）

### 3. パフォーマンス要件
- **処理範囲**: 各プレイヤー周囲の21×21ブロック（441ブロック）を最大範囲とする
- **更新間隔**: 最大20tick（1秒）に1回の処理実行
- **マルチプレイヤー対応**: 複数プレイヤーが同時に機能を使用可能

## 技術仕様

### 1. イベント処理
- **PlayerMoveEvent**: プレイヤー移動時の範囲チェック
- **PlayerJoinEvent**: プレイヤー参加時の初期化
- **PlayerQuitEvent**: プレイヤー退出時のクリーンアップ

### 2. データ管理
```java
// プレイヤーごとの可視化ブロック管理
Map<UUID, Set<Location>> playerVisibleBlocks;

// y=50～HEIGHTでの表示ブロック管理
Set<Location> displayedBlocks;
```

### 3. 主要メソッド
- `updateVisibleBlocks(Player player)`: プレイヤー周囲のブロック更新
- `copyBlockToDisplay(Location sourceLocation)`: y=-50～HEIGHTからy=50～HEIGHTへのブロックコピー
- `removeBlockFromDisplay(Location displayLocation)`: y=50～HEIGHTからのブロック削除
- `isWithinRange(Location playerLoc, Location blockLoc)`: 範囲内判定
- `calculateDisplayY(int sourceY)`: 対象Y座標から表示Y座標への変換

### 4. 設定可能項目
- 可視化範囲（デフォルト: 10ブロック）
- 対象Y座標範囲（デフォルト: y=-50～y=319）
- 表示Y座標範囲（デフォルト: y=50～y=419）
- Y座標オフセット（デフォルト: +100）
- 更新間隔（デフォルト: 20tick）

## 動作フロー

### 1. プレイヤー移動時
1. プレイヤーの現在位置を取得
2. 新しい可視化範囲を計算（半径10m）
3. 範囲内のy=-50～HEIGHTブロックをスキャン
4. 新たに範囲内に入ったブロックをy=50～HEIGHTにコピー（高さ変換適用）
5. 範囲外に出たブロックをy=50～HEIGHTから削除

### 2. 複数プレイヤー対応
1. 各プレイヤーの可視化範囲を個別管理
2. 同じy=50～HEIGHT位置に複数プレイヤーがアクセスする場合の重複処理を回避
3. 最後のプレイヤーが範囲外に出た時点でブロック削除

### 3. エラーハンドリング
- ワールド境界外への処理防止
- 非読み込みチャンクでの処理スキップ
- プレイヤー退出時のリソース解放

## パフォーマンス最適化

### 1. 処理軽減策
- 移動距離が小さい場合の処理スキップ
- チャンク単位での効率的なブロック検索
- 非同期処理での負荷分散

### 2. メモリ管理
- 使用後のLocationオブジェクト解放
- プレイヤー退出時のデータクリーンアップ
- 定期的なガベージコレクション対象データの整理

## 制限事項

### 1. 技術的制限
- ワールド境界外での動作は保証されない
- 非読み込みチャンクでの処理は行われない
- 同一座標でのブロック重複は考慮されない

### 2. 運用制限
- 同時アクティブプレイヤー数: 推奨50人以下
- 可視化範囲: 最大半径20ブロックまで推奨

## 今後の拡張予定

### 1. 機能拡張
- 複数Y座標レイヤーの対応
- カスタムブロック配置パターン
- プレイヤー個別設定機能

### 2. パフォーマンス改善
- キャッシュシステムの導入
- 差分更新アルゴリズムの実装
- マルチスレッド処理の最適化

## 設定ファイル (config.yml)
```yaml
aroundfloor:
  # 可視化範囲（ブロック単位）
  visibility-range: 10
  # 対象Y座標範囲
  source-y-min: -50
  source-y-max: 319
  # 表示Y座標範囲
  display-y-min: 50
  display-y-max: 419
  # Y座標オフセット
  y-offset: 100
  # 更新間隔（tick）
  update-interval: 20
  # デバッグモード
  debug: false
``` 